
@options timing

@goal soft_folder_created
@reached_if [[ -d "soft" ]]
  mkdir soft

@goal tush_installed
@depends_on soft_folder_created
@reached_if [[ -f "soft/tush/bin/tush-check" ]]
  echo
  echo "Fetching tush..."
  echo

  cd "soft"

  if which wget >/dev/null
  then
    wget https://github.com/adolfopa/tush/archive/master.tar.gz -O./tush.tar.gz
    tar xzvf ./tush.tar.gz
    rm ./tush.tar.gz
    mv tush-master tush
  else
    git clone --depth 1 https://github.com/adolfopa/tush.git
    rm -r tush/.git
  fi

@goal soft_installed
@depends_on tush_installed

@goal cleaned

@goal cleaned_soft
@reached_if [[ ! -d "soft" ]]
  rm -r "soft"

@goal cleaned_all
@depends_on cleaned cleaned_soft

@goal debug
  awk --version | head -n 1
  bash --version| head -n 1

@goal tested
@depends_on tush_installed debug
  rm -f /tmp/makesure.*

  export PATH="$PATH:$MYDIR/soft/tush/bin"

  for f in tests/*.tush
  do
    if tush-check "$f"
    then
      echo "TESTS PASSED : $f"
    else
      echo >&2 "!!! TESTS FAILED !!! : $f"
      exit 1
    fi
    for f1 in /tmp/makesure.*
    do
      if [[ "$f1" != "/tmp/makesure.*" ]]
      then
        echo >&2 "!!! $f1 not deleted !!!"
        exit 1
      fi
    done
  done

@goal default
@depends_on tested
